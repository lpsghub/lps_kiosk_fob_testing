<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>RFID Sign In/Out</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#111; color:#eee; display:flex; min-height:100vh; align-items:center; justify-content:center; }
    .card { background:#1b1b1b; padding:32px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.35); width:min(680px, 90vw); }
    h1 { margin:0 0 12px; font-weight:600; font-size:28px; }
    .status { margin:8px 0 20px; font-size:18px; opacity:.9; min-height:24px; }
    .hidden-input { position:absolute; left:-9999px; }
    .row { display:flex; gap:12px; margin-top:10px; }
    button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-size:16px; }
    .primary { background:#2d7ef7; color:white; }
    .ghost { background:#2a2a2a; color:#ddd; }
    .admin { margin-top:18px; padding-top:16px; border-top:1px solid #333; opacity:0.95; }
    label { display:block; margin-top:8px; font-size:14px; color:#bbb; }
    input[type="password"], input[type="text"] { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #333; background:#0f0f0f; color:#eee; }
    small { color:#888; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Swipe Your Keyfob</h1>
    <div class="status" id="message">Waiting for swipe…</div>

    <input id="rfid" class="hidden-input" autofocus />

    <div class="row">
      <button class="ghost" id="focusBtn" title="Refocus scanner input">Refocus</button>
      <button class="ghost" id="clearBtn">Clear Message</button>
    </div>

    <div class="admin">
      <h3 style="margin:8px 0;">Admin Tools (Testing)</h3>
      <label for="scriptUrl">Apps Script Web App URL</label>
      <input id="scriptUrl" type="text" placeholder="https://script.google.com/macros/s/ABC123/exec" />

      <label for="token">Admin Token <small>(temporary; used to run manual reset)</small></label>
      <input id="token" type="password" placeholder="Enter admin token" />

      <div class="row">
        <button class="primary" id="saveBtn">Save Settings</button>
        <button class="ghost" id="resetBtn">Run Manual Reset (auto-checkout)</button>
      </div>
    </div>
  </div>

  <script>
    const input   = document.getElementById('rfid');
    const msg     = document.getElementById('message');
    const urlEl   = document.getElementById('scriptUrl');
    const tokenEl = document.getElementById('token');

    // Load saved settings
    urlEl.value   = localStorage.getItem('scriptUrl') || '';
    tokenEl.value = '';

    function focusInput(){ input.focus(); }
    document.getElementById('focusBtn').addEventListener('click', focusInput);
    document.getElementById('clearBtn').addEventListener('click', () => msg.textContent = 'Waiting for swipe…');
    document.getElementById('saveBtn').addEventListener('click', () => {
      if (!urlEl.value) { alert('Please enter the Apps Script Web App URL'); return; }
      localStorage.setItem('scriptUrl', urlEl.value.trim());
      msg.textContent = 'Settings saved.';
    });

    // Manual reset button
    document.getElementById('resetBtn').addEventListener('click', async () => {
      const scriptUrl = (localStorage.getItem('scriptUrl') || urlEl.value || '').trim();
      const token     = tokenEl.value.trim();
      if (!scriptUrl) { alert('Enter and save the Apps Script Web App URL first.'); return; }
      if (!token)     { alert('Enter the admin token.'); return; }
      try {
        const res = await fetch(scriptUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ action:'reset', token })
        });
        const text = await res.text();
        msg.textContent = text;
      } catch (e) {
        msg.textContent = 'Error running manual reset.';
        console.error(e);
      }
    });

    // Swipe handling
    focusInput();
    document.body.addEventListener('click', focusInput);
    input.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        const scriptUrl = (localStorage.getItem('scriptUrl') || urlEl.value || '').trim();
        if (!scriptUrl) { msg.textContent = 'Set the Apps Script Web App URL in Admin Tools.'; return; }

        const tag = input.value.trim().replace(/\D/g, '');
        input.value = '';
        if (!tag) { msg.textContent = 'Invalid swipe.'; return; }

        try {
          const res = await fetch(scriptUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams({ tag })
          });
          const text = await res.text();
          msg.textContent = text;
        } catch (err) {
          msg.textContent = 'Error logging swipe.';
          console.error(err);
        }
      }
    });
  </script>
</body>
</html>
