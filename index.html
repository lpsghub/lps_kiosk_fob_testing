<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lindenwold Staff Sign In/Out</title>
<style>
  :root{--bg:#0e1116;--card:#151a21;--muted:#9fb0c3;--ok:#2ecc71;--out:#f39c12;--err:#e74c3c;--accent:#2d7ef7;}
  html,body{margin:0;height:100%;background:var(--bg);color:#e8eef4;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:4vh 3vw}
  .card{width:min(1000px,96vw);background:var(--card);border:1px solid #202835;border-radius:22px;padding:4vh 4vw;box-shadow:0 30px 80px rgba(0,0,0,.35);position:relative}
  .brand{position:absolute;top:18px;left:24px;color:var(--muted);font-size:14px;letter-spacing:.08em;text-transform:uppercase}
  .gear{position:absolute;top:12px;right:12px;width:44px;height:44px;border-radius:12px;border:1px solid #243041;display:grid;place-items:center;color:#cfd9e6;background:#11161d}
  .title{font-size:clamp(32px,4.2vw,56px);margin:18px 0 10px;font-weight:800;letter-spacing:.02em}
  .status{margin:18px 0 10px;font-size:clamp(32px,4vw,50px);font-weight:800;line-height:1.15}
  .status.ok{color:var(--ok)} .status.out{color:var(--out)} .status.err{color:var(--err)}
  .hint{font-size:clamp(16px,1.8vw,18px);color:var(--muted)}
  .last{margin-top:14px;color:#b7c6d8;font-size:clamp(14px,1.6vw,16px)}
  .hidden-input{position:absolute;left:-9999px;top:-9999px}
  .flash{animation:flash 600ms ease}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(46,204,113,0)}40%{box-shadow:0 0 0 10px rgba(46,204,113,.25)}100%{box-shadow:0 0 0 0 rgba(46,204,113,0)}}
  .flash-out{animation:flashOut 600ms ease}
  @keyframes flashOut{0%{box-shadow:0 0 0 0 rgba(243,156,18,0)}40%{box-shadow:0 0 0 10px rgba(243,156,18,.25)}100%{box-shadow:0 0 0 0 rgba(243,156,18,0)}}
  .flash-err{animation:flashErr 700ms ease}
  @keyframes flashErr{0%{box-shadow:0 0 0 0 rgba(231,76,60,0)}40%{box-shadow:0 0 0 12px rgba(231,76,60,.25)}100%{box-shadow:0 0 0 0 rgba(231,76,60,0)}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="card">
      <div class="brand" id="brandText">Lindenwold Staff Sign In/Out</div>

      <div class="title" id="titleText">Lindenwold Staff Sign In/Out</div>
      <div id="status" class="status">Waiting for swipe…</div>
      <div class="hint">Hold your fob to the reader. No need to touch the screen.</div>
      <div class="last" id="last"></div>

      <input id="rfidHidden" class="hidden-input" autofocus />
    </div>
  </div>

<script>
  // ===== Defaults (hard-wired) =====
  const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzjvp9PkwYxeHOVHl4SMFfTOh4drqaiQ6xQZR4qmKzfKgzKltvtMY2wsBBU1bhRE9H7sg/exec';

  const SITES = {
    HS: 'Lindenwold HS Staff Sign In/Out',
    MS: 'Lindenwold MS Staff Sign In/Out',
    S4: 'Lindenwold S4 Staff Sign In/Out',
    S5: 'Lindenwold S5 Staff Sign In/Out',
    ECC:'Lindenwold ECC Staff Sign In/Out',
    DIST:'Lindenwold Staff Sign In/Out'
  };
  const DEFAULT_SITE = 'HS';

  // ===== Elements =====
  const brandEl = document.getElementById('brandText');
  const titleEl = document.getElementById('titleText');
  const statusEl = document.getElementById('status');
  const lastEl = document.getElementById('last');
  const hiddenInput = document.getElementById('rfidHidden');
  const card = document.getElementById('card');

  // ===== Site resolve =====
  function getQuerySite(){
    const m = (location.search.match(/[?&]site=([^&]+)/i) || [])[1];
    return m ? decodeURIComponent(m).toUpperCase() : '';
  }
  function getSiteKey(){
    const fromQuery = getQuerySite();
    if (fromQuery && SITES[fromQuery]) return fromQuery;
    return DEFAULT_SITE;
  }
  function renderSite(){
    const key = getSiteKey();
    const label = SITES[key] || SITES[DEFAULT_SITE];
    brandEl.textContent = label;
    titleEl.textContent = label;
  }

  // ===== Networking =====
  const REQ_TIMEOUT_MS = 8000;
  const GAP_MS = 80;
  const MAX_LEN = 128;

  function normalizeTag(s){ return String(s||'').trim().toUpperCase().replace(/[^A-Z0-9.\-]/g,''); }
  function maskTag(s){
    const digits = String(s||'').replace(/\D/g,'');
    const last4 = digits.slice(-4);
    return '•••• ' + (last4 || '0000');
  }

  function showPending(t){ statusEl.textContent = t; statusEl.className='status'; }
  function showError(msg){ statusEl.textContent=msg; statusEl.className='status err'; flash('err'); }
  function showResponse(text){
    const t = String(text||'');
    if(/Logged\s+in\b/i.test(t)){ statusEl.textContent=t; statusEl.className='status ok'; flash('in'); }
    else if(/Logged\s+out\b/i.test(t)){ statusEl.textContent=t; statusEl.className='status out'; flash('out'); }
    else if(/Unauthorized|Error|Missing|Already reset today/i.test(t)){ statusEl.textContent=t; statusEl.className='status err'; flash('err'); }
    else { statusEl.textContent=t || 'Waiting for swipe…'; statusEl.className='status'; }
  }
  function flash(kind){
    card.classList.remove('flash','flash-out','flash-err');
    void card.offsetWidth;
    if(kind==='in') card.classList.add('flash');
    else if(kind==='out') card.classList.add('flash-out');
    else card.classList.add('flash-err');
  }

  async function tryFetchWithRetry(url, body, retries, backoffsMs){
    const doPost = () => {
      const ctrl = new AbortController();
      const timer = setTimeout(()=>ctrl.abort(), REQ_TIMEOUT_MS);
      return fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body,
        signal: ctrl.signal
      }).finally(()=>clearTimeout(timer));
    };

    let lastErr;
    for (let i=0;i<=retries;i++){
      try{
        const res = await doPost();
        const txt = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt}`);
        return txt;
      }catch(e){
        lastErr = e;
        if (i < retries){
          await new Promise(r=>setTimeout(r, backoffsMs[i] || 500));
          continue;
        }
      }
    }
    throw lastErr;
  }

  async function warmAndRetry(url, body){
    try{ await fetch(url, { method:'GET' }); }catch{}
    try{
      const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      return await r.text();
    }catch(e){ return null; }
  }

  async function submitTag(raw){
    const url = DEFAULT_SCRIPT_URL + `?site=${encodeURIComponent(getSiteKey())}`;
    const tag = normalizeTag(raw);
    if(!tag){ showError('Invalid swipe.'); return; }

    showPending(`Swipe received… (${maskTag(tag)})`);
    const t0 = performance.now();

    const body = new URLSearchParams({ tag });

    try{
      const text = await tryFetchWithRetry(url, body, 2, [300, 800]);
      showResponse(text);
      lastEl.textContent = `Response in ${Math.round(performance.now()-t0)} ms — ${new Date().toLocaleTimeString()}`;
    }catch(err){
      const warmed = await warmAndRetry(url, body).catch(()=>null);
      if (warmed) {
        showResponse(warmed);
        lastEl.textContent = `Recovered after warm-up — ${new Date().toLocaleTimeString()}`;
      } else {
        showError('Taking longer than expected. Check Wi-Fi or try again.');
      }
    }
  }

  // ===== Global capture with idle-submit =====
  let buf=''; let lastTs=0; let submitTimer=null;
  function scheduleIdleSubmit(){ clearTimeout(submitTimer); submitTimer=setTimeout(()=>{ const out=normalizeTag(buf); buf=''; if(out) submitTag(out); }, GAP_MS); }

  document.addEventListener('keydown', (evt) => {
    const now = performance.now(); const gap = now - lastTs; if(gap > GAP_MS) buf=''; lastTs = now;
    if(/^[A-Za-z0-9.\-]$/.test(evt.key)){ if(buf.length<MAX_LEN) buf += evt.key; scheduleIdleSubmit(); evt.preventDefault(); }
    else if(evt.key==='Enter' || evt.key==='Tab'){ clearTimeout(submitTimer); const out=normalizeTag(buf); buf=''; if(out) submitTag(out); evt.preventDefault(); }
  });

  hiddenInput.addEventListener('keydown', (e) => {
    if(e.key==='Enter' || e.key==='Tab'){ const out=normalizeTag(hiddenInput.value); hiddenInput.value=''; if(out) submitTag(out); e.preventDefault(); }
  });

  // Init
  window.addEventListener('load', () => {
    renderSite();
    window.focus(); document.body.focus(); hiddenInput.focus();
  });
  setInterval(() => { window.focus(); document.body.focus(); hiddenInput.focus(); }, 20000);
</script>
</body>
</html>
